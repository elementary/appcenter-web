---

name: Publish

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 * * * *' # Hourly
  workflow_dispatch:

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y ruby-nokogiri

      - name: Checkout
        uses: actions/checkout@master
        with:
          fetch-depth: 0

      - name: Cache
        uses: actions/cache@v2
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}

      - name: Setup
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7
          bundler-cache: true

      - name: Build
        run: |
          ruby ./generate-loki.rb
          ruby ./generate-hera.rb
          ruby ./generate-flatpak.rb
          docker run \
          -v ${{ github.workspace }}:/srv/jekyll -v ${{ github.workspace }}/_site:/srv/jekyll/_site \
          jekyll/builder:3 /bin/bash -c "chmod 777 /srv/jekyll && jekyll build --future"

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
